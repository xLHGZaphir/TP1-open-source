#TP1 Systemd

Apres avoir installé Fedora 31, docker et désactiver selinux

1. First steps

On vérifie la version de systemd qui doit etre supérieure à 241, ici version 243 :

[root@localhost ~]# systemctl --version 
systemd 243 (v243.4-1.fc31)
+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4+SECCOMP +BLKID 
+ELFUTILS +KMOD +IDN2 -IDN +PCRE2 default-hierarchy=unified

Pour vérifier que systemd est PID 1, on fait la commande ps -ef : 
zaphir      1120       1  0 12:40 ?        00:00:00 /usr/lib/systemd/systemd --user

et il est bien PID 1

Ensuite pour donner le nom de 5 processus systeme on peut faire la commande ps -ef ou alors la commande 
ps --ppid 2 -p 2 --deselect : 

    774 ?        00:00:00 ModemManager -> processus système qui permet de gerer la, 2g, 3g et 4g
    776 ?        00:00:00 bluetoothd -> processus système du bluetooth machine 
    779 ?        00:00:00 firewalld -> processus système du pare feu machine
    839 ?        00:00:00 sshd -> processus système lié au service ssh 
    930 ?        00:00:00 dockerd -> processus système lié a Docker

2. Gestion du temps

Voici le résultat de la première commande :

[root@localhost ~]# timedatectl
               Local time: ven. 2019-11-29 15:08:19 CET
           Universal time: ven. 2019-11-29 14:08:19 UTC
                 RTC time: ven. 2019-11-29 14:08:19
                Time zone: Europe/Paris (CET, +0100)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
         
Local Time : Heure locale 
Universal Time : Heure basée sur le GMT
RTC Time : Heure de la pile Bios 

Il est pertinent d'utiliser le RTC car si on utilise notre machine sans connexion, notre machine sera 
quand même à l'heure grâce à la pile Bios.

j'ai changé la timezone pour Rome en faisant ceci : 

[root@localhost ~]# timedatectl set-timezone Europe/Rome
[root@localhost ~]# 

On nous demande ensuite de désactiver l'utilisation de la synchronisation NTP :

[root@localhost ~]# timedatectl set-ntp 0
[root@localhost ~]# 

Pour vérifier que c'est coupé on refait la première commande : 

[root@localhost ~]# timedatectl
               Local time: ven. 2019-11-29 15:34:20 CET
           Universal time: ven. 2019-11-29 14:34:20 UTC
                 RTC time: ven. 2019-11-29 14:34:20
                Time zone: Europe/Rome (CET, +0100)
System clock synchronized: yes
              NTP service: inactive
          RTC in local TZ: no
          
3. Gestion de noms

Le changement de nom : 

[root@localhost ~]# hostnamectl set-hostname VMZaphir
[root@localhost ~]# exit
déconnexion
[zaphir@localhost ~]$ hostname
VMZaphir

La différence entre : 
--pretty = Nom sans regle de nommage adapté pour l'utilisateur mais pas pour la machine 
--static = Nom donné de base en général localhost
--transient = Nom donné par le MDNS ou DHCP

Ensuite nous pouvons mettre un nom de deployement : 

[root@VMZaphir ~]# hostnamectl set-deployment Bonjour

Puis on vérifie 

[root@VMZaphir ~]# hostnamectl 
   Static hostname: VMZaphir
         Icon name: computer-vm
           Chassis: vm
        Deployment: Bonjour
        Machine ID: 6c3ea4afea054d059105d365cce6d0b9
           Boot ID: f42dda2d58fa4ab29d639da6c58177b2
    Virtualization: vmware
  Operating System: Fedora 31 (Server Edition)
       CPE OS Name: cpe:/o:fedoraproject:fedora:31
            Kernel: Linux 5.3.12-300.fc31.x86_64
      Architecture: x86-64
      
4. Gestion du réseau (et résolution de noms)

on essaye la commande, on obtient ceci : 

[root@VMZaphir ~]# nmcli con show
NAME     UUID                                  TYPE      DEVICE  
ens33    53acbbeb-b190-3c6d-aab6-fff92545632c  ethernet  ens33   
docker0  c24980a6-b255-447a-8656-1f0eed3fd9f3  bridge    docker0 

Pour afficher les infos DHCP avec network manager voici la commande :

[root@VMZaphir ~]# cat /var/lib/NetworkManager/internal-53acbbeb-b190-3c6d-aab6-fff92545632c-ens33.lease 
# This is private data. Do not parse.
ADDRESS=192.168.43.3
NETMASK=255.255.255.0
ROUTER=192.168.43.145
SERVER_ADDRESS=192.168.43.145
NEXT_SERVER=192.168.43.145
BROADCAST=192.168.43.255
T1=1800
T2=3150
LIFETIME=3600
DNS=192.168.43.145
HOSTNAME=VMZaphir
CLIENTID=01000c29ed14eb
VENDOR_SPECIFIC=414e44524f49445f4d455445524544

Désactiver NetworkManager : 

[root@VMZaphir ~]# systemctl disable NetworkManager 
Removed /etc/systemd/system/multi-user.target.wants/NetworkManager.service.
Removed /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.
Removed /etc/systemd/system/network-online.target.wants/NetworkManager-wait-online.service.

Activer systemd-networkd :

[root@VMZaphir ~]# systemctl enable systemd-networkd
Created symlink /etc/systemd/system/dbus-org.freedesktop.network1.service → /usr/lib/systemd/system/systemd-networkd.service.
Created symlink /etc/systemd/system/multi-user.target.wants/systemd-networkd.service → /usr/lib/systemd/system/systemd-networkd.service.
Created symlink /etc/systemd/system/sockets.target.wants/systemd-networkd.socket → /usr/lib/systemd/system/systemd-networkd.socket.
Created symlink /etc/systemd/system/network-online.target.wants/systemd-networkd-wait-online.service → /usr/lib/systemd/system/systemd-networkd-wait-online.service.

Pour check : 

[root@VMZaphir ~]# systemctl is-enabled NetworkManager
disable
et
[root@VMZaphir ~]# systemctl is-enabled systemd-networkd
enabled

Pour pouvoir configurer le réseau avec systemd, j'ai créé un fichier ens33.network dans /etc/systemd/network/ :

  GNU nano 4.3                              /etc/systemd/network/ens33.network                              Modifié  
[Match]
Key=ens33 

[Network]
Address=192.168.43.100/24
DNS=1.1.1.1

System resolvd :

Pour start et start au démarrage systemd-resolved on fait les deux commandes suivantes : 

[root@VMZaphir ~]# systemctl start systemd-resolved
[root@VMZaphir ~]# systemctl enable  systemd-resolved
Created symlink /etc/systemd/system/dbus-org.freedesktop.resolve1.service → /usr/lib/systemd/system/systemd-resolved.service.
Created symlink /etc/systemd/system/multi-user.target.wants/systemd-resolved.service → /usr/lib/systemd/system/systemd-resolved.service.

On vérifie qu'il est bien lancé : 

[root@VMZaphir ~]# systemctl status systemd-resolved
● systemd-resolved.service - Network Name Resolution
   Loaded: loaded (/usr/lib/systemd/system/systemd-resolved.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2019-12-05 12:15:36 CET; 1min 17s ago
     Docs: man:systemd-resolved.service(8)
           https://www.freedesktop.org/wiki/Software/systemd/resolved
           https://www.freedesktop.org/wiki/Software/systemd/writing-network-configuration-managers
           https://www.freedesktop.org/wiki/Software/systemd/writing-resolver-clients
 Main PID: 1740 (systemd-resolve)
   Status: "Processing requests..."
    Tasks: 1 (limit: 2307)
   Memory: 11.5M
   CGroup: /system.slice/systemd-resolved.service
           └─1740 /usr/lib/systemd/systemd-resolved

On vérifie que un DNS tourne localement sur notre machine : 

[root@VMZaphir ~]# ss -ltunp
Netid State  Recv-Q Send-Q        Local Address:Port   Peer Address:Port                                             
udp   UNCONN 0      0             127.0.0.53%lo:53          0.0.0.0:*     users:(("systemd-resolve",pid=1740,fd=18)) 
udp   UNCONN 0      0        192.168.43.3%ens33:68          0.0.0.0:*     users:(("NetworkManager",pid=1354,fd=20))  
udp   UNCONN 0      0                   0.0.0.0:68          0.0.0.0:*     users:(("dhclient",pid=1110,fd=9))         
udp   UNCONN 0      0                   0.0.0.0:5355        0.0.0.0:*     users:(("systemd-resolve",pid=1740,fd=12)) 
udp   UNCONN 0      0                      [::]:5355           [::]:*     users:(("systemd-resolve",pid=1740,fd=14)) 
tcp   LISTEN 0      128                 0.0.0.0:5355        0.0.0.0:*     users:(("systemd-resolve",pid=1740,fd=13)) 
tcp   LISTEN 0      128           127.0.0.53%lo:53          0.0.0.0:*     users:(("systemd-resolve",pid=1740,fd=19)) 
tcp   LISTEN 0      128                 0.0.0.0:22          0.0.0.0:*     users:(("sshd",pid=873,fd=5))              
tcp   LISTEN 0      128                       *:9090              *:*     users:(("systemd",pid=1,fd=124))           
tcp   LISTEN 0      128                    [::]:5355           [::]:*     users:(("systemd-resolve",pid=1740,fd=15)) 
tcp   LISTEN 0      128                    [::]:22             [::]:*     users:(("sshd",pid=873,fd=7))              

On fait une résolution DNS avec dig : 

[root@VMZaphir ~]# dig www.facebook.com

; <<>> DiG 9.11.13-RedHat-9.11.13-2.fc31 <<>> www.facebook.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21080
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1280
;; QUESTION SECTION:
;www.facebook.com.		IN	A

;; ANSWER SECTION:
www.facebook.com.	1210	IN	CNAME	star-mini.c10r.facebook.com.
star-mini.c10r.facebook.com. 31	IN	A	157.240.21.35

;; Query time: 36 msec
;; SERVER: 192.168.43.15#53(192.168.43.15)
;; WHEN: jeu. déc. 05 12:44:31 CET 2019
;; MSG SIZE  rcvd: 90



